## GROUP BY - 집약

CASE식과 GROUP BY 구로 여러 레코드를 하나로 집약할수있다.


GROUP BY 로 테이블을 집약할때
정렬, 해시알고리즘을 사용한다
같은 해시키를 가진 그룹을 모아 집약하는 방법을 사용

의문: 빠른이유가 풀스캔하고 정렬 vs 해시키로 변환후 같은해시키를 모으기때문?
GROUP BY 의 유일성이 높으면 더 효율적으로 작동?


GROUP BY 성능주의점 
정렬과 해시 모두 워킹메모리가 사용되는데, 
충분한 워킹메모리가 확보되지않으면 스왑이 발생한다.

저장소위의 파일이 사용될수가있기때문이다.
연산대상 레코드수가 많은 GROUP BY구나 집약함수를 사용하는 SQL에선 충분한 성능검증을 실행해줘야한다. 

스왑이 발생하면서 성능이 악화될뿐아니라 최악의경우에는
SQL구문이 비정상적으로 종료되는경우도 발생할수있다.


## GROUP BY - 자르기

CASE방식과 함께 사용하여
테이블의 레코드를 나눌수도있다. 


### GROUP BY 와 PARTITION BY
 1) GROUP BY
 집약 + 자르기까지 포함되어있음
 => 데이터를 요약해서 하나씩 보여준다.
 ```sql
SELECT Continent
		,SUM(GNP)
FROM world.country
group by Continent;
```
![](https://velog.velcdn.com/images/dudwls0505/post/4681d9a8-bebc-41d2-8a82-67a28d7382e0/image.png)

2) PARTITION BY 
집약기능은 없고 자른다는 느낌만  남아있다.
=> 전체데이터 전부를 보여준다.

```sql
SELECT Continent
		,SUM(GNP) OVER(PARTITION BY Continent)
FROM world.country;
```


![](https://velog.velcdn.com/images/dudwls0505/post/e301eb10-8212-45d5-ac7b-20b38e63e2cd/image.png)




## 반복계의 공포
포장계 = 여러 SQL행을 한번에 처리한다.

**가장 큰단점은 성능**

#### SQL이 실행될때의 다양한 처리들
SQL구문을 네트워크로 전송
DB연결
=> 커넥션 풀로 인해서 그렇게 크게 문제가되진않음
SQL구문 파스
=> 가장문제, DBMS마다 방법도 다르고 종류도 굉장히 많다. 
SQL구문의 실행계획생성 , 평가
결과 집합을 네트워크로 전송

### 반복의 단점


반복계
- 분산처리가 불가능하다
- 구문을 튜닝할수있는 가능성이 거의없다.

해결법?

포장계로 다시작성? 
=> 현실적으로 불가능

SQL을 빠르게수정?
=> 튜닝할것도 없을만큼 반복계의 구문은 간단하다

다중화처리
=> CPU나 디스크같은 리소스에여유가있고 처리를 나눌수있는 키가 명확하다면 선형에 가깝게 스케일할수있다.
키가 명확하지않고, 순서가 중요한 처리면 불가능한 방법

**반복계는 튜닝 자체를 할수있는 선택지가 한정적이다.**

### 반복계의장점

**변경가능성**
포장계는 SQL구문이 복잡한만큼 실행계획의 변경가능성이 크다는 단점이있다.
반복계는 SQL구문지 지나치게 단순하기때문에 변경가능성이 적고 있다고 해도 차이가 크지않다. 

**트랜잭션 관리**
트랜잭션을 미세하게 제어할수있다. 

장점과 단점에 대한 트레이드오프 고려해야한다.



### 스터디후기

반복계에 대한 설명은 알겠는데 
개인적으로 포장계라는 개념이 조금 애매했다.
포장계라는 개념은 상황마다 달라질수있는 개념인것같고
반복계를 쓴다 혹은 포장계를 쓴다는 그 **조직의 룰에의해 결정**되는 경향이 있다는 말씀들을 하셨다.

이번주 분량에서는 결국 반복계라는것이있고, 포장계라는것이 있고 어떤 장단점이있는지 상황에대한 트레이드오프를 고려할수있으면 좋을것 같다는 생각이 들었다.




REF: https://project-notwork.tistory.com/53
